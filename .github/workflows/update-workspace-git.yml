# .github/workflows/update-workspace-git.yml
name: Update Workspace Git Integration

on:
  workflow_call:
    inputs:
      workspace-id:
        required: true
        type: string
        description: 'Workspace ID to update'
      git-branch:
        required: true
        type: string
        description: 'Git branch to pull from'
      fabric-connection-id:
        required: true
        type: string
        description: 'Fabric GitHub connection ID'
    secrets:
      tenant-id:
        required: true
      client-id:
        required: true
      client-secret:
        required: true

jobs:
  update-workspace:
    name: Update Workspace
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get Fabric API Token
        id: get-token
        env:
          TENANT_ID: ${{ secrets.tenant-id }}
          CLIENT_ID: ${{ secrets.client-id }}
          CLIENT_SECRET: ${{ secrets.client-secret }}
        run: |
          set -euo pipefail

          : "${TENANT_ID:?TENANT_ID is empty}"
          : "${CLIENT_ID:?CLIENT_ID is empty}"
          : "${CLIENT_SECRET:?CLIENT_SECRET is empty}"

          TOKEN_URL="https://login.microsoftonline.com/${TENANT_ID}/oauth2/v2.0/token"

          RESPONSE=$(curl -sS -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${CLIENT_ID}" \
            --data-urlencode "client_secret=${CLIENT_SECRET}" \
            --data-urlencode "scope=https://api.fabric.microsoft.com/.default" \
            --data-urlencode "grant_type=client_credentials")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')

          if [[ -z "$TOKEN" ]]; then
            echo "Error: Failed to get access token"
            echo "$RESPONSE" | jq '{error, error_description, trace_id, correlation_id}'
            exit 1
          fi

          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          echo "Successfully obtained access token"

      # ─────────────────────────────────────────────────────────────
      # 1) Determine whether workspace already has a Git connection
      #    - Treat 200 as connected
      #    - Treat 400 WorkspaceNotConnectedToGit as not connected
      #    - Anything else is a real failure
      # ─────────────────────────────────────────────────────────────
      - name: Detect existing workspace Git connection
        id: ws-git
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Workspace ID: $WS"
          echo "Target Branch: ${{ inputs.git-branch }}"
          echo "Connection ID: ${{ inputs.fabric-connection-id }}"

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X GET \
            "${FABRIC_API_URL}/workspaces/${WS}/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "status_http=$HTTP_CODE" >> "$GITHUB_OUTPUT"

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Workspace has a Git connection (status returned 2xx)"
            echo "$BODY" | jq . || true
            echo "connected=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$HTTP_CODE" == "400" ]] && echo "$BODY" | jq -e '.errorCode=="WorkspaceNotConnectedToGit"' >/dev/null 2>&1; then
            echo "ℹ Workspace is NOT connected to Git (WorkspaceNotConnectedToGit)"
            echo "$BODY" | jq . || true
            echo "connected=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "✗ Unexpected error when checking git status. HTTP $HTTP_CODE"
          echo "$BODY" | jq . || echo "$BODY"
          exit 1

      # ─────────────────────────────────────────────────────────────
      # 2) If not connected, connect.
      #    - Treat 2xx as success
      #    - Treat 409 WorkspaceAlreadyConnectedToGit as success (race-safe)
      #    - Anything else is failure
      # ─────────────────────────────────────────────────────────────
      - name: Connect workspace to Git (if missing)
        id: connect
        if: steps.ws-git.outputs.connected == 'false'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Connecting workspace to Git..."
          echo "Workspace ID: $WS"
          echo "Connection ID: ${{ inputs.fabric-connection-id }}"
          echo "Branch: ${{ inputs.git-branch }}"
          echo "Repo: ${{ github.repository_owner }}/${{ github.event.repository.name }}"

          PAYLOAD=$(cat <<EOF
          {
            "gitProviderDetails": {
              "gitProviderType": "GitHub",
              "ownerName": "${{ github.repository_owner }}",
              "repositoryName": "${{ github.event.repository.name }}",
              "branchName": "${{ inputs.git-branch }}",
              "directoryName": "/"
            },
            "myGitCredentials": {
              "source": "ConfiguredConnection",
              "connectionId": "${{ inputs.fabric-connection-id }}"
            }
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/connect" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Connected to Git (HTTP $HTTP_CODE)"
            echo "$BODY" | jq . || true
            echo "result=connected" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$HTTP_CODE" == "409" ]] && echo "$BODY" | jq -e '.errorCode=="WorkspaceAlreadyConnectedToGit"' >/dev/null 2>&1; then
            echo "✓ Already connected (409 WorkspaceAlreadyConnectedToGit). Continuing..."
            echo "$BODY" | jq . || true
            echo "result=already_connected" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "✗ Failed to connect workspace to Git. HTTP $HTTP_CODE"
          echo "$BODY" | jq . || echo "$BODY"
          exit 1

      # ─────────────────────────────────────────────────────────────
      # 3) Initialize connection (required before commit/update APIs work)
      #    Handles both immediate (200) and long-running (202) operations.
      #    Outputs:
      #      required_action: CommitToGit | UpdateFromGit | (empty)
      #      remote_commit_hash
      #      workspace_head
      # ─────────────────────────────────────────────────────────────
      - name: Initialize Git Connection (required)
        id: init
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Initializing Git connection for workspace: $WS"

          HEADERS_FILE="$(mktemp)"
          BODY_FILE="$(mktemp)"

          HTTP_CODE=$(curl -sS -D "$HEADERS_FILE" -o "$BODY_FILE" -w "%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/initializeConnection" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{}")

          if [[ "$HTTP_CODE" == "200" ]]; then
            RESULT="$(cat "$BODY_FILE")"
            echo "✓ Initialize completed (200)"
            echo "$RESULT" | jq .
          elif [[ "$HTTP_CODE" == "202" ]]; then
            OP_ID=$(grep -i '^x-ms-operation-id:' "$HEADERS_FILE" | awk '{print $2}' | tr -d '\r')
            RETRY=$(grep -i '^retry-after:' "$HEADERS_FILE" | awk '{print $2}' | tr -d '\r')
            [[ -z "$RETRY" ]] && RETRY=10

            echo "⏳ Initialize running (operationId=$OP_ID). Polling every ${RETRY}s..."

            while true; do
              OP=$(curl -sS -X GET "${FABRIC_API_URL}/operations/${OP_ID}" \
                -H "Authorization: Bearer $FABRIC_TOKEN" \
                -H "Content-Type: application/json")

              STATE=$(echo "$OP" | jq -r '.status')
              echo "LRO status: $STATE"

              if [[ "$STATE" == "Succeeded" ]]; then
                break
              fi
              if [[ "$STATE" == "Failed" ]]; then
                echo "$OP" | jq .
                exit 1
              fi
              sleep "$RETRY"
            done

            RESULT=$(curl -sS -X GET \
              "${FABRIC_API_URL}/operations/${OP_ID}/result" \
              -H "Authorization: Bearer $FABRIC_TOKEN" \
              -H "Content-Type: application/json")

            echo "✓ Initialize result (202->Succeeded)"
            echo "$RESULT" | jq .
          else
            echo "✗ Initialize failed. HTTP $HTTP_CODE"
            cat "$BODY_FILE" | jq . || cat "$BODY_FILE"
            exit 1
          fi

          REQ=$(echo "$RESULT" | jq -r '.requiredAction // empty')
          REMOTE=$(echo "$RESULT" | jq -r '.remoteCommitHash // empty')
          HEAD=$(echo "$RESULT" | jq -r '.workspaceHead // empty')

          echo "required_action=$REQ" >> "$GITHUB_OUTPUT"
          echo "remote_commit_hash=$REMOTE" >> "$GITHUB_OUTPUT"
          echo "workspace_head=$HEAD" >> "$GITHUB_OUTPUT"

      # ─────────────────────────────────────────────────────────────
      # 4) Keep branch aligned (best-effort). Only meaningful once connected.
      # ─────────────────────────────────────────────────────────────
      - name: Update Git Branch (best effort)
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Updating workspace connection to branch: ${{ inputs.git-branch }}"

          PAYLOAD=$(cat <<EOF
          {
            "branchName": "${{ inputs.git-branch }}"
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X PATCH \
            "${FABRIC_API_URL}/workspaces/${WS}/git/updateConnection" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Git branch updated"
          else
            echo "⚠ Warning: Failed to update branch. HTTP $HTTP_CODE"
            echo "$BODY" | jq . || echo "$BODY"
          fi

      # ─────────────────────────────────────────────────────────────
      # 5) Perform only the action Fabric requests after initialization.
      #    - CommitToGit OR UpdateFromGit (or nothing)
      # ─────────────────────────────────────────────────────────────
      - name: Commit workspace changes to Git (only if required)
        if: steps.init.outputs.required_action == 'CommitToGit'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Fabric requested CommitToGit. Committing changes..."

          PAYLOAD=$(cat <<EOF
          {
            "mode": "All",
            "comment": "Automated commit from workspace - ${{ github.sha }}"
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/commitToGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ CommitToGit succeeded"
            echo "$BODY" | jq . || true
          else
            echo "✗ CommitToGit failed. HTTP $HTTP_CODE"
            echo "$BODY" | jq . || echo "$BODY"
            exit 1
          fi

      - name: Update workspace from Git (only if required)
        if: steps.init.outputs.required_action == 'UpdateFromGit'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Fabric requested UpdateFromGit. Updating workspace..."

          REMOTE="${{ steps.init.outputs.remote_commit_hash }}"
          HEAD="${{ steps.init.outputs.workspace_head }}"

          if [[ -z "$REMOTE" || -z "$HEAD" ]]; then
            echo "✗ Missing required hashes from initializeConnection:"
            echo "remoteCommitHash='$REMOTE'"
            echo "workspaceHead='$HEAD'"
            exit 1
          fi

          PAYLOAD=$(cat <<EOF
          {
            "remoteCommitHash": "$REMOTE",
            "workspaceHead": "$HEAD"
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/updateFromGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ UpdateFromGit accepted/succeeded"
            echo "$BODY" | jq . || true
          else
            echo "✗ UpdateFromGit failed. HTTP $HTTP_CODE"
            echo "$BODY" | jq . || echo "$BODY"
            exit 1
          fi

      # ─────────────────────────────────────────────────────────────
      # 6) Status at end (best-effort)
      # ─────────────────────────────────────────────────────────────
      - name: Get Updated Git Status (best effort)
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Getting updated Git status..."
          RESPONSE=$(curl -sS -w "\n%{http_code}" -X GET \
            "${FABRIC_API_URL}/workspaces/${WS}/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Git Status HTTP: $HTTP_CODE"
          echo "$BODY" | jq . || echo "$BODY"

      - name: Summary
        run: |
          echo "### Workspace Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace ID**: ${{ inputs.workspace-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Branch**: ${{ inputs.git-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Connection ID**: ${{ inputs.fabric-connection-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Initialize requiredAction**: ${{ steps.init.outputs.required_action }}" >> $GITHUB_STEP_SUMMARY
