# .github/workflows/update-workspace-git.yml
name: Update Workspace Git Integration

on:
  workflow_call:
    inputs:
      workspace-id:
        required: true
        type: string
        description: "Workspace ID to update"
      git-branch:
        required: true
        type: string
        description: "Git branch to pull from"
      fabric-connection-id:
        required: true
        type: string
        description: "Fabric GitHub connection ID"
    secrets:
      tenant-id:
        required: true
      client-id:
        required: true
      client-secret:
        required: true

jobs:
  update-workspace:
    name: Update Workspace
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get Fabric API Token
        id: get-token
        env:
          TENANT_ID: ${{ secrets.tenant-id }}
          CLIENT_ID: ${{ secrets.client-id }}
          CLIENT_SECRET: ${{ secrets.client-secret }}
        run: |
          set -euo pipefail

          : "${TENANT_ID:?TENANT_ID is empty}"
          : "${CLIENT_ID:?CLIENT_ID is empty}"
          : "${CLIENT_SECRET:?CLIENT_SECRET is empty}"

          TOKEN_URL="https://login.microsoftonline.com/${TENANT_ID}/oauth2/v2.0/token"

          RESPONSE=$(curl -sS -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${CLIENT_ID}" \
            --data-urlencode "client_secret=${CLIENT_SECRET}" \
            --data-urlencode "scope=https://api.fabric.microsoft.com/.default" \
            --data-urlencode "grant_type=client_credentials")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')
          if [[ -z "$TOKEN" ]]; then
            echo "Error: Failed to get access token"
            echo "$RESPONSE" | jq '{error, error_description, trace_id, correlation_id}'
            exit 1
          fi

          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          echo "Successfully obtained access token"

      # ─────────────────────────────────────────────────────────────
      # Detect:
      # - 2xx on /git/status => connected + initialized
      # - 400 WorkspaceNotConnectedToGit => not connected
      # - 400 WorkspaceGitConnectionNotInitialized => connected, not initialized
      # Anything else => fail
      # Outputs:
      #   connected: true|false
      #   initialized: true|false
      #   status_error_code: <string>
      # ─────────────────────────────────────────────────────────────
      - name: Detect workspace git connection state
        id: ws-git
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Workspace ID: $WS"
          echo "Target Branch: ${{ inputs.git-branch }}"
          echo "Connection ID: ${{ inputs.fabric-connection-id }}"
          echo "Repo: ${{ github.repository_owner }}/${{ github.event.repository.name }}"

          # defaults
          echo "connected=false" >> "$GITHUB_OUTPUT"
          echo "initialized=false" >> "$GITHUB_OUTPUT"
          echo "status_error_code=" >> "$GITHUB_OUTPUT"

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X GET \
            "${FABRIC_API_URL}/workspaces/${WS}/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ /git/status returned 2xx -> connected + initialized"
            echo "$BODY" | jq . || true
            echo "connected=true" >> "$GITHUB_OUTPUT"
            echo "initialized=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$HTTP_CODE" == "400" ]]; then
            EC=$(echo "$BODY" | jq -r '.errorCode // empty')
            echo "status_error_code=$EC" >> "$GITHUB_OUTPUT"
            echo "$BODY" | jq . || true

            if [[ "$EC" == "WorkspaceNotConnectedToGit" ]]; then
              echo "ℹ Not connected"
              echo "connected=false" >> "$GITHUB_OUTPUT"
              echo "initialized=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            if [[ "$EC" == "WorkspaceGitConnectionNotInitialized" ]]; then
              echo "ℹ Connected but not initialized"
              echo "connected=true" >> "$GITHUB_OUTPUT"
              echo "initialized=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "✗ Unexpected /git/status response. HTTP $HTTP_CODE"
          echo "$BODY" | jq . || echo "$BODY"
          exit 1

      # ─────────────────────────────────────────────────────────────
      # Connect (only if not connected)
      # - 2xx => ok
      # - 409 WorkspaceAlreadyConnectedToGit => ok (race-safe)
      # - else => fail
      # ─────────────────────────────────────────────────────────────
      - name: Connect workspace to Git (if needed)
        id: connect
        if: steps.ws-git.outputs.connected == 'false'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Connecting workspace to Git..."
          echo "Workspace ID: $WS"
          echo "Connection ID: ${{ inputs.fabric-connection-id }}"
          echo "Branch: ${{ inputs.git-branch }}"

          PAYLOAD=$(cat <<EOF
          {
            "gitProviderDetails": {
              "gitProviderType": "GitHub",
              "ownerName": "${{ github.repository_owner }}",
              "repositoryName": "${{ github.event.repository.name }}",
              "branchName": "${{ inputs.git-branch }}",
              "directoryName": "/"
            },
            "myGitCredentials": {
              "source": "ConfiguredConnection",
              "connectionId": "${{ inputs.fabric-connection-id }}"
            }
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/connect" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Connected to Git (HTTP $HTTP_CODE)"
            echo "$BODY" | jq . || true
            exit 0
          fi

          if [[ "$HTTP_CODE" == "409" ]] && echo "$BODY" | jq -e '.errorCode=="WorkspaceAlreadyConnectedToGit"' >/dev/null 2>&1; then
            echo "✓ Already connected (409). Continuing..."
            echo "$BODY" | jq . || true
            exit 0
          fi

          echo "✗ Failed to connect. HTTP $HTTP_CODE"
          echo "$BODY" | jq . || echo "$BODY"
          exit 1

      # ─────────────────────────────────────────────────────────────
      # Initialize (only if not initialized)
      # Handles:
      # - 200 => immediate result
      # - 202 => poll operations/<id> then operations/<id>/result
      # Outputs:
      #   required_action
      #   remote_commit_hash
      #   workspace_head
      # ─────────────────────────────────────────────────────────────
      - name: Initialize git connection (if needed)
        id: init
        if: steps.ws-git.outputs.initialized == 'false'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Initializing Git connection..."
          HEADERS_FILE="$(mktemp)"
          BODY_FILE="$(mktemp)"

          HTTP_CODE=$(curl -sS -D "$HEADERS_FILE" -o "$BODY_FILE" -w "%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/initializeConnection" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{}")

          if [[ "$HTTP_CODE" == "200" ]]; then
            RESULT="$(cat "$BODY_FILE")"
            echo "✓ Initialized (200)"
          elif [[ "$HTTP_CODE" == "202" ]]; then
            OP_ID=$(grep -i '^x-ms-operation-id:' "$HEADERS_FILE" | awk '{print $2}' | tr -d '\r')
            RETRY=$(grep -i '^retry-after:' "$HEADERS_FILE" | awk '{print $2}' | tr -d '\r')
            [[ -z "$RETRY" ]] && RETRY=10

            echo "⏳ Initialize running (op=$OP_ID). Polling every ${RETRY}s..."
            while true; do
              OP=$(curl -sS -X GET "${FABRIC_API_URL}/operations/${OP_ID}" \
                -H "Authorization: Bearer $FABRIC_TOKEN" \
                -H "Content-Type: application/json")
              STATE=$(echo "$OP" | jq -r '.status')

              echo "LRO status: $STATE"
              if [[ "$STATE" == "Succeeded" ]]; then
                break
              fi
              if [[ "$STATE" == "Failed" ]]; then
                echo "$OP" | jq .
                exit 1
              fi
              sleep "$RETRY"
            done

            RESULT=$(curl -sS -X GET \
              "${FABRIC_API_URL}/operations/${OP_ID}/result" \
              -H "Authorization: Bearer $FABRIC_TOKEN" \
              -H "Content-Type: application/json")
            echo "✓ Initialized (202->Succeeded)"
          else
            echo "✗ Initialize failed. HTTP $HTTP_CODE"
            cat "$BODY_FILE" | jq . || cat "$BODY_FILE"
            exit 1
          fi

          echo "$RESULT" | jq . || true

          REQ=$(echo "$RESULT" | jq -r '.requiredAction // empty')
          REMOTE=$(echo "$RESULT" | jq -r '.remoteCommitHash // empty')
          HEAD=$(echo "$RESULT" | jq -r '.workspaceHead // empty')

          echo "required_action=$REQ" >> "$GITHUB_OUTPUT"
          echo "remote_commit_hash=$REMOTE" >> "$GITHUB_OUTPUT"
          echo "workspace_head=$HEAD" >> "$GITHUB_OUTPUT"

      # If already initialized, set empty init outputs so downstream steps don't break
      - name: Normalize init outputs
        id: init-final
        run: |
          set -euo pipefail
          echo "required_action=${{ steps.init.outputs.required_action || '' }}" >> "$GITHUB_OUTPUT"
          echo "remote_commit_hash=${{ steps.init.outputs.remote_commit_hash || '' }}" >> "$GITHUB_OUTPUT"
          echo "workspace_head=${{ steps.init.outputs.workspace_head || '' }}" >> "$GITHUB_OUTPUT"

      # Best-effort branch alignment (safe even if already on branch)
      - name: Update git branch (best effort)
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "Updating workspace connection to branch: ${{ inputs.git-branch }}"
          PAYLOAD=$(cat <<EOF
          {
            "branchName": "${{ inputs.git-branch }}"
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X PATCH \
            "${FABRIC_API_URL}/workspaces/${WS}/git/updateConnection" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ Branch updated"
          else
            echo "⚠ Warning: branch update failed. HTTP $HTTP_CODE"
            echo "$BODY" | jq . || echo "$BODY"
          fi

      # Only do what Fabric asks after initialize (prevents NotInitialized errors)
      - name: Commit workspace changes to Git (only if required)
        if: steps.init-final.outputs.required_action == 'CommitToGit'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          echo "requiredAction=CommitToGit -> committing workspace changes..."
          PAYLOAD=$(cat <<EOF
          {
            "mode": "All",
            "comment": "Automated commit from workspace - ${{ github.sha }}"
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/commitToGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ CommitToGit succeeded"
            echo "$BODY" | jq . || true
          else
            echo "✗ CommitToGit failed. HTTP $HTTP_CODE"
            echo "$BODY" | jq . || echo "$BODY"
            exit 1
          fi

      - name: Update workspace from Git (only if required)
        if: steps.init-final.outputs.required_action == 'UpdateFromGit'
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          REMOTE="${{ steps.init-final.outputs.remote_commit_hash }}"
          HEAD="${{ steps.init-final.outputs.workspace_head }}"

          echo "requiredAction=UpdateFromGit -> applying remote to workspace..."
          echo "remoteCommitHash: $REMOTE"
          echo "workspaceHead: $HEAD"

          if [[ -z "$REMOTE" || -z "$HEAD" ]]; then
            echo "✗ Missing hashes from initializeConnection result."
            exit 1
          fi

          PAYLOAD=$(cat <<EOF
          {
            "remoteCommitHash": "$REMOTE",
            "workspaceHead": "$HEAD"
          }
          EOF
          )

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            "${FABRIC_API_URL}/workspaces/${WS}/git/updateFromGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "✓ UpdateFromGit accepted/succeeded"
            echo "$BODY" | jq . || true
          else
            echo "✗ UpdateFromGit failed. HTTP $HTTP_CODE"
            echo "$BODY" | jq . || echo "$BODY"
            exit 1
          fi

      - name: Get updated git status (best effort)
        env:
          FABRIC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          set -euo pipefail
          FABRIC_API_URL="https://api.fabric.microsoft.com/v1"
          WS="${{ inputs.workspace-id }}"

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X GET \
            "${FABRIC_API_URL}/workspaces/${WS}/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Git Status HTTP: $HTTP_CODE"
          echo "$BODY" | jq . || echo "$BODY"

      - name: Summary
        run: |
          echo "### Workspace Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace ID**: ${{ inputs.workspace-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Branch**: ${{ inputs.git-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Connection ID**: ${{ inputs.fabric-connection-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Connected**: ${{ steps.ws-git.outputs.connected }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Initialized**: ${{ steps.ws-git.outputs.initialized }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Initialize requiredAction**: ${{ steps.init-final.outputs.required_action }}" >> $GITHUB_STEP_SUMMARY
