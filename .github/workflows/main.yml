name: Fabric Deployment Pipeline

on:
  push:
    branches:
      - "feature/**"
  workflow_dispatch:
    inputs:
      branch:
        description: 'Feature branch name'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  WS_PREFIX: feat
  VAR_PREFIX: env_var  # GitHub Variables prefix for all environments

  # Ensure these are using 'vars', NOT 'secrets'
  DEV_CAPACITY_ID: ${{ vars.DEV_CAPACITY_ID }}
  TEST_CAPACITY_ID: ${{ vars.TEST_CAPACITY_ID }}
  PROD_CAPACITY_ID: ${{ vars.PROD_CAPACITY_ID }}
  DEV_WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
  TEST_WORKSPACE_ID: ${{ vars.TEST_WORKSPACE_ID }}
  PROD_WORKSPACE_ID: ${{ vars.PROD_WORKSPACE_ID }}
  GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
  GITHUB_REPOSITORY_OWNER: ${{ github.event.repository.owner.login }}
  FABRIC_VAR_FILE_PATH: variable_template.VariableLibrary/variables.json

  
  FABRIC_CONNECTION_ID: ${{ vars.FABRIC_CONNECTION_ID }}
  WORKSPACE_ADMIN_ID: ${{ vars.WORKSPACE_ADMIN_ID }}

jobs:
  # ══════════════════════════════════════════════════════════════
  # 0. Validate Service Principal Permissions
  # ══════════════════════════════════════════════════════════════
  check-spn-permissions:
    name: "0. Validate SPN Permissions"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./.github/workflows/scripts/spn_evaluator.sh

      - name: Run SPN Evaluator
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          ./.github/workflows/scripts/spn_evaluator.sh --output table

  # ══════════════════════════════════════════════════════════════
  # 1. Create Feature Workspace
  # ══════════════════════════════════════════════════════════════
  create-feature-workspace:
    name: "1. Create Feature Workspace"
    needs: [check-spn-permissions]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Feature Workspace
        uses: ./.github/workflows/create-fabric-workspace.yml
        with:
          branch-name: ${{ github.ref_name }}
          workspace-prefix: feat
          capacity-id: ${{ vars.DEV_CAPACITY_ID }}
          git-branch: ${{ github.ref_name }}
          fabric-connection-id: ${{ vars.FABRIC_CONNECTION_ID }}
          workspace-admin-id: ${{ vars.WORKSPACE_ADMIN_ID }}
        secrets:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # ══════════════════════════════════════════════════════════════
  # 2. Update Variables for Dev Environment
  # ══════════════════════════════════════════════════════════════
  update-dev-variables:
    name: "2. Update Dev Variables"
    needs: [create-feature-workspace]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update variables.json for Dev
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e dev \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for dev environment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  # ══════════════════════════════════════════════════════════════
  # 3. Deploy to Dev Workspace (⏸️ REQUIRES MANUAL TRIGGER)
  # ══════════════════════════════════════════════════════════════
  deploy-to-dev:
    name: "3. Deploy to Dev (Manual Approval Required)"
    needs: [update-dev-variables]
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: https://app.fabric.microsoft.com/groups/${{ vars.DEV_WORKSPACE_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Login to Azure
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Deploy to Dev Workspace
        run: |
          echo "Deploying to Dev Workspace: ${{ vars.DEV_WORKSPACE_ID }}"
          # Add your deployment logic here
          # This would call your update-workspace-git logic

  # ══════════════════════════════════════════════════════════════
  # 4. Update Variables for Test Environment
  # ══════════════════════════════════════════════════════════════
  update-test-variables:
    name: "4. Update Test Variables"
    needs: [deploy-to-dev]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update variables.json for Test
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e test \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for test environment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  # ══════════════════════════════════════════════════════════════
  # 5. Deploy to Test Workspace (⏸️ REQUIRES APPROVAL)
  # ══════════════════════════════════════════════════════════════
  deploy-to-test:
    name: "5. Deploy to Test (Approval Required)"
    needs: [update-test-variables]
    runs-on: ubuntu-latest
    environment:
      name: test
      url: https://app.fabric.microsoft.com/groups/${{ vars.TEST_WORKSPACE_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Login to Azure
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Deploy to Test Workspace
        run: |
          echo "Deploying to Test Workspace: ${{ vars.TEST_WORKSPACE_ID }}"
          # Add your deployment logic here

  # ══════════════════════════════════════════════════════════════
  # 6. Update Variables for Production Environment
  # ══════════════════════════════════════════════════════════════
  update-prod-variables:
    name: "6. Update Prod Variables"
    needs: [deploy-to-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update variables.json for Production
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./.github/workflows/scripts/update_variables.sh
          ./.github/workflows/scripts/update_variables.sh \
            -p ${{ env.VAR_PREFIX }} \
            -e prod \
            -f ${{ env.FABRIC_VAR_FILE_PATH }} \
            -r ${{ github.repository }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add ${{ env.FABRIC_VAR_FILE_PATH }}
            git commit -m "chore: update variables.json for production environment [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi

  # ══════════════════════════════════════════════════════════════
  # 7. Deploy to Production Workspace (⏸️ REQUIRES APPROVAL)
  # ══════════════════════════════════════════════════════════════
  deploy-to-prod:
    name: "7. Deploy to Production (Approval Required)"
    needs: [update-prod-variables]
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://app.fabric.microsoft.com/groups/${{ vars.PROD_WORKSPACE_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Login to Azure
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}

      - name: Deploy to Production Workspace
        run: |
          echo "Deploying to Production Workspace: ${{ vars.PROD_WORKSPACE_ID }}"
          # Add your deployment logic here